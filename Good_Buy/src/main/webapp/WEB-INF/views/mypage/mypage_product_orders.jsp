<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="${pageContext.request.contextPath}/resources/img/g_favicon.ico" type="image/x-icon">
<link rel="icon" href="${pageContext.request.contextPath}/resources/img/g_favicon.ico" type="image/x-icon">

<title>ÍµøÎ∞îÏù¥ - Ï§ëÍ≥†Í±∞Îûò, Ïù¥ÏõÉÍ≥º Ìï®Íªò Îçî ÏâΩÍ≤å!</title>

<!-- Í∏∞Î≥∏ CSS Î∞è JS -->
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/common.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/default.css">
<script src="${pageContext.request.contextPath}/resources/js/jquery-3.7.1.js"></script>
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/fontawesome/all.min.css" />
<script src="${pageContext.request.contextPath}/resources/fontawesome/all.min.js"></script>

<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/main.css">
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/mypage.css">
<script src="${pageContext.request.contextPath}/resources/js/slick.js"></script>
</head>

<body>
    <header>
        <jsp:include page="/WEB-INF/views/inc/header.jsp"></jsp:include>
    </header>
    
    <main>
        <section class="wrapper">
            <div class="page-inner">
                <h2 class="page-ttl">ÎßàÏù¥ÌéòÏù¥ÏßÄ</h2>
                
                <section class="my-wrap">
                    <aside class="my-menu">
                        <h3>Í±∞Îûò Ï†ïÎ≥¥</h3>
                        <a href="MyStore">ÎÇòÏùò ÏÉÅÏ†ê</a>
                        <a href="GoodPay">ÍµøÌéòÏù¥</a>
                        <a href="MyOrder" class="active">Íµ¨Îß§ÎÇ¥Ïó≠</a>
                        <a href="MySales">ÌåêÎß§ÎÇ¥Ïó≠</a>
                        <h3>ÎÇòÏùò Ï†ïÎ≥¥</h3>
                        <a href="MyInfo">Í≥ÑÏ†ïÏ†ïÎ≥¥</a>
                        <a href="MyWish">Í¥ÄÏã¨Î™©Î°ù</a>
                        <a href="MyReview">ÎÇòÏùò ÌõÑÍ∏∞</a>
                        <a href="MyReviewHistory">ÎÇ¥Í∞Ä Ïì¥ ÌõÑÍ∏∞</a>
                        <a href="MySupport">1:1Î¨∏ÏùòÎÇ¥Ïó≠</a>
                    </aside>

                    <div class="my-container">
                        <div class="contents-ttl">
                            <h3>Íµ¨Îß§ÎÇ¥Ïó≠ <small>(Ï¥ù <span>${orderCount}</span>Í±¥)</small></h3>
                            <div class="product-list">
                                <c:choose>
                                    <c:when test="${empty order}">
                                        <ul>
                                            <li>Íµ¨Îß§ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</li>
                                        </ul>
                                    </c:when>
                                    <c:otherwise>
                                        <c:forEach var="product" items="${order}">
                                            <li class="product-card">
                                                <img src="${pageContext.request.contextPath}/resources/img/product_thumb.jpg"
                                                     class="card-thumb" alt="thumbnail" height="180px"/>
                                                <div class="card-info">
                                                    <div class="category">
                                                        <span>${product.product_category}</span>
                                                        <span class="type">ÏßÅÍ±∞Îûò</span>
                                                    </div>
                                                    <div class="ttl">
                                                        <c:if test="${product.product_status == 3}">
                                                            [Í±∞ÎûòÏôÑÎ£å]
                                                        </c:if>
                                                        ${product.product_title}
                                                    </div>
                                                    <div class="price">
                                                        <fmt:formatNumber value="${product.product_price}" type="number" pattern="#,###" />Ïõê
                                                    </div>
                                                    <div class="card-row">
                                                        <span class="add">${product.product_trade_adr1}</span>
                                                        <span class="name">${product.mem_nick}</span>
                                                    </div>
                                                    
                                                    <!-- ÌõÑÍ∏∞ ÏûëÏÑ±ÌïòÍ∏∞ Î≤ÑÌäº (ÏÉÅÌíà Ï†ïÎ≥¥ Ìè¨Ìï®) -->
<!--                                                     	<input type="hidden" name="product_id" id="hiddenProductId"> -->
<!-- 	                                                    <button class="open-modal-btn" -->
<%-- 														        data-product-id="${product.product_id}" --%>
<%-- 														        data-title="${product.product_title}" --%>
<%-- 														        data-buyer="${product.mem_nick}" --%>
<%--  														        data-review-cnt="${product.review_cnt}" --%>
<%-- 														        type="button" ${product.review_cnt == 1 ? 'disabled' : ''}> --%>
<%-- 														    ${product.review_cnt == 1 ? 'ÏûëÏÑ±ÏôÑÎ£åüì©' : 'ÌõÑÍ∏∞ ÏûëÏÑ±ÌïòÍ∏∞üìÆ'} --%>
<!-- 														</button> -->
                                                    	<input type="hidden" name="product_id" id="hiddenProductId">
                                                    	<c:choose>
                                                    		<c:when test="${product.review_cnt == 0}">
	                                                    		 <button class="open-modal-btn"
															        data-product-id="${product.product_id}"
															        data-title="${product.product_title}"
															        data-buyer="${product.mem_nick}">
															        ÌõÑÍ∏∞ ÏûëÏÑ±ÌïòÍ∏∞üìÆ
															     </button>
                                                    		</c:when>
                                                    		<c:otherwise><a href='MyReviewHistory'>ÏûëÏÑ±ÏôÑÎ£åüì©</a></c:otherwise>
                                                    	</c:choose>
                                                </div>
                                            </li>
                                        </c:forEach>
                                    </c:otherwise>
                                </c:choose>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </main>
    
    <footer>
        <jsp:include page="/WEB-INF/views/inc/footer.jsp"></jsp:include>
    </footer>

    <!-- ÌõÑÍ∏∞ ÏûëÏÑ± Î™®Îã¨ (Î∞òÎ≥µÎ¨∏ Î∞îÍπ•Ïóê Î™®Îã¨ ÌïòÎÇòÎßå ÏÇ¨Ïö©) -->
    <div id="review-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>
                <span id="buyerName"></span>ÎãòÍªò Íµ¨Îß§Ìïú [<span id="productTitle"></span>]<br>ÌõÑÍ∏∞ Î≥¥ÎÇ¥Í∏∞üìÆ
            </h2>
            <input type="hidden" id="modal_product_id"> <!-- idÏ†ÄÏû•Ïö© -->
<!--             <input type="hidden" id="modal_review_cnt"> Î¶¨Î∑∞ Í∞ØÏàò Ï†ÄÏû•Ïö© -->
            <textarea rows="4" cols="50" id="review_content" placeholder="ÌõÑÍ∏∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî."></textarea>
            <br>
            <button id="close-modal">Îã´Í∏∞</button>
            <button id="submit-review">ÏûëÏÑ±ÏôÑÎ£å</button>
        </div>
    </div>

    <script type="text/javascript">
    $(document).ready(function () {
        // ÌõÑÍ∏∞ ÏûëÏÑ±ÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        $(".open-modal-btn").click(function () {
            const productId = $(this).data("product-id");
            const productTitle = $(this).data("title");
            const buyerName = $(this).data("buyer");
//             const review_cnt = $(this).data("review-cnt");

            // Î™®Îã¨Ïóê Îç∞Ïù¥ÌÑ∞ Ï£ºÏûÖ
            $("#buyerName").text(buyerName);
            $("#productTitle").text(productTitle);
            $("#modal_product_id").val(productId);
//             $("#modal_review_cnt").val(review_cnt);


            $("#review-modal").fadeIn(300);
        });

        // Î™®Îã¨ Îã´Í∏∞
        $("#close-modal").click(function () {
            $("#review-modal").fadeOut(300);
        });

        // ÌõÑÍ∏∞ Ï†úÏ∂ú Ïù¥Î≤§Ìä∏
        $("#submit-review").click(function () {
            const reviewText = $("#review_content").val();
            const productId = $("#modal_product_id").val();
            const productTitle = $("#productTitle").text();
// 			const review_cnt = $("#modal_review_cnt").val();

            if (!reviewText.trim()) {
                alert("ÌõÑÍ∏∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!");
                return;
            }

            // Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏Ïö© ÏΩòÏÜî Ï∂úÎ†•
            console.log("Î¶¨Î∑∞ ÎÇ¥Ïö©: " + reviewText);
            console.log("ÏÉÅÌíà ID: " + productId);
            console.log("ÏÉÅÌíà Ï†úÎ™©: " + productTitle);
// 			console.log(">>>>>>>>>>>>"+review_cnt);
			  

            // AjaxÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
            $.ajax({
                url: "MyReviewText",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    review: reviewText,
                    product_title: productTitle,
                    product_id: productId,
//                     review_cnt : review_cnt
                }),
                success: function () {
                    alert("ÌõÑÍ∏∞Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!");
                    $("#review-modal").fadeOut(300);
                    $("#review_content").val("");
                    location.reload();

//                     Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî (ÎòêÎäî Ïà®ÍπÄ Ï≤òÎ¶¨)
//                     $(".clicked-review-btn").prop("disabled", true).text("ÌõÑÍ∏∞ ÏûëÏÑ± ÏôÑÎ£å").removeClass("open-modal-btn");
                },
                error: function () {
                    alert("ÌõÑÍ∏∞ Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                }
            });
        });
    });

</script>

<script type="text/javascript">
	

</script>
</body>
</html>
